/*! Express.Admin 最后修改于：2016-01-22 */
!function(a){function b(a){return a&&a.preventDefault?a.preventDefault():window.event.returnValue=!1,!1}function c(a){return a&&a.stopPropagation?a.stopPropagation():window.event.cancelBubble=!0,!1}a.fn.plugin_areaSelectModal=function(d,e){function f(a,b){var c=['<ul class="list-inline">'];jQuery.each(v,function(b,d){var e=d.c.split(","),f=e[e.length-3];f==a&&c.push('<li><a  href="javascript:;" data-value="'+d.id+'">'+d.n+"</a> </li>")}),c.push("</ul>"),b.html(c.join(" "))}var g,h,i,j,k,l,m=a(this),n={id:"plugin_areaSelect",title:"选择区域",deep:3,required:0,placement:"right",valueContainerId:null,url:"/Common/GetSubAreaSimple"},o=a.extend(n,d);a(this).each(function(){a(this).id=o.id,a(this).title=o.title,a(this).deep=o.deep,a(this).valueContainerId=o.valueContainerId,a(this).required=o.required,a(this).placement=o.placement});var p,q={sheng:{id:null,text:null},shi:{id:null,text:null},xian:{id:null,text:null},select:{id:null,text:null}},r="area_select_tab_sheng"+o.id,s="area_select_tab_shi"+o.id,t="area_select_tab_xian"+o.id,u="area_select_tab_close"+o.id,v=window.area_popover_data,w=function(){var a=['<div id="',o.id,'" class="area-select-ctrl"><ul class="nav nav nav-tabs ">','<li class="">','    <a href="#'+r+'" data-toggle="tab">',"         &nbsp;&nbsp;省&nbsp;&nbsp;","    </a>","  </li>",'  <li class="',o.deep>1?"":"hide",'">','      <a href="#'+s+'" data-toggle="tab"  >',"&nbsp;&nbsp;市&nbsp;&nbsp;","      </a>","   </li>",'   <li class="',o.deep>2?"":"hide",'">','      <a href="#'+t+'" data-toggle="tab" >',"&nbsp;&nbsp;县&nbsp;&nbsp;","      </a>","   </li>",'   <li class="pull-right">',"      <a id="+u+' href="#"   style="background-color: #fff;padding: 5px 10px">',"X","</a>","</li>"," </ul>",' <div class="tab-content ">','    <div class="tab-pane fade" id="'+r+'"> ',"       <p>加载中</p>","     </div>",'     <div class="tab-pane fade"  id="'+s+'">',"       <p></p>","  </div>",' <div class="tab-pane fade"  id="'+t+'">',"    <p></p>","</div> "," </div></div>"];m.val();m.unbind("click"),m.popover({trigger:"click",placement:o.placement,container:"body",html:!0,content:a.join("")}).popover("show")};m.bind("click",function(a){b(a),w(),c(a)});var x=[],y=[],z=[];a.each(v,function(a,b){var c=b.c.substring(0,b.c.length-1).replace(",1,","");x[b.id]={c:c,n:b.n,y:b.y,t:b.t,fn:""}}),m.typeahead({items:15,minLength:1,container:"body",delay:100,source:function(b,c){var d=[];a.each(v,function(b,c){var e=x[c.id].c.split(","),f="";a.each(e,function(a,b){f+=x[b].n+"/"}),f=f.substring(0,f.length-1),y[f]=c.id,z[c.id]=c.n+","+c.y,x[c.id].fn=f,d.push(f)}),c(d)},afterShown:function(){q={sheng:{id:null,text:null},shi:{id:null,text:null},xian:{id:null,text:null},select:{id:null,text:null}},a(".popover-backdrop").trigger("click")},afterHide:function(b){var c=a.grep(x,function(a,b){return null!=a&&a.fn==m.val()});0==c.length&&(m.val(""),a("#"+o.valueContainerId).val(""))},matcher:function(b){if(a.inArray(y[b],[10,2,23,3])>-1)return!1;if(x[y[b]].t>o.deep)return!1;var c=this,d=this.query.toLowerCase();b=z[y[b]];var e=b.split(","),f=!1;return e.length>0&&a.each(e,function(a,b){var e=c.displayText(b);return 0==e.toLowerCase().indexOf(d)?(f=!0,!1):void 0}),f},updater:function(a){q={sheng:{id:null,text:null},shi:{id:null,text:null},xian:{id:null,text:null},select:{id:null,text:null}};var b=x[y[a]];if(1==b.t&&(q.sheng={text:b.n,id:y[a]},q.select={text:b.n,id:y[a]},e(q)),2==b.t){q.shi={text:b.n,id:y[a]};var c=b.c.split(",")[0];q.sheng={text:x[c].n,id:c},q.select={text:b.n,id:y[a]},e(q)}if(3==b.t){q.xian={text:b.n,id:y[a]};var d=b.c.split(",")[1];q.shi={text:x[d].n,id:d};var c=b.c.split(",")[0];q.sheng={text:x[c].n,id:c},q.select={text:b.n,id:y[a]},e(q)}var f="";return null!=q.sheng.id&&""!=q.sheng.id&&(f=null!=q.shi.id&&""!=q.shi.id?null!=q.xian.id&&""!=q.xian.id?q.sheng.text+"/"+q.shi.text+"/"+q.xian.text:q.sheng.text+"/"+q.shi.text:q.sheng.text),f}}),m.on("shown.bs.popover",function(){m.select(),a(document.body).append('<div class="modal-backdrop popover-backdrop" style="width:100%;height:100%;background-color:#e1e1e1;filter: alpha(opacity=10);opacity: .1;z-index: 1059;"></div>'),h=a("#"+o.id),g=h.parents("popover").first(),i=a("#"+r),j=a("#"+s),k=a("#"+t),l=a("#"+u),B(),A()}),m.on("hide.bs.popover",function(){null!=q.xian.id?(q.select.id=q.xian.id,q.select.text=q.xian.text):null!=q.shi.id?(q.select.id=q.shi.id,q.select.text=q.shi.text):null!=q.sheng.id?(q.select.id=q.sheng.id,q.select.text=q.sheng.text):(q.select.id=null,q.select.text=""),a(".popover-backdrop").remove(),e(q)});var A=function(){if(f(1,i),null!=o.valueContainerId&&(p=a("#"+o.valueContainerId).val()),null==p||""==p||0==p||isNaN(p))a('a[href="#'+r+'"]').tab("show");else{var b,c,d;jQuery.each(v,function(e,g){if(g.id==p){if(1==g.t){a('a[href="#'+r+'"]').tab("show"),b=p;var h=i.find('[data-value="'+b+'"]');return h.addClass("current"),f(b,j),q.sheng.id=b,q.sheng.text=h.text(),q.shi.id=null,q.shi.text="",q.xian.id=null,q.xian.text="",!1}if(2==g.t){var l=g.c.split(","),m=l[l.length-3];b=m,c=p,a('a[href="#'+s+'"]').tab("show"),f(1,i);var h=i.find('[data-value="'+b+'"]');h.addClass("current"),f(b,j);var n=j.find('[data-value="'+c+'"]');return n.addClass("current"),f(c,k),q.sheng.id=b,q.sheng.text=h.text(),q.shi.id=c,q.shi.text=n.text(),q.xian.id=null,q.xian.text="",!1}if(3==g.t){var l=g.c.split(","),m=l[l.length-3];b=l[l.length-4],c=l[l.length-3],d=p,a('a[href="#'+t+'"]').tab("show"),f(1,i);var h=i.find('[data-value="'+b+'"]');h.addClass("current"),f(b,j);var n=j.find('[data-value="'+c+'"]');n.addClass("current"),f(c,k);var o=k.find('[data-value="'+d+'"]');return o.addClass("current"),q.sheng.id=b,q.sheng.text=h.text(),q.shi.id=c,q.shi.text=n.text(),q.xian.id=d,q.xian.text=o.text(),!1}return!1}})}},B=function(){a(".popover-backdrop").off("click").on("click",function(b){a(".popover-backdrop").unbind("click"),D()}),l.on("click",function(a){a.preventDefault(),D()}),i.on("click",function(b){var c=a(b.target).attr("data-value");if(a(this).find("a").removeClass("current"),a(b.target).addClass("current"),null!=c){a('a[href="#'+s+'"]').trigger("click");var d=a(b.target).text();if(q.sheng.id=c,q.sheng.text=d,q.shi.id=null,q.shi.text="",q.xian.id=null,q.xian.text="",1==o.deep)return D(),!1;f(c,j)}}),j.on("click",function(b){var c=a(b.target).attr("data-value");if(a(this).find("a").removeClass("current"),a(b.target).addClass("current"),null==c)return D(),!1;a('a[href="#'+t+'"]').trigger("click");var d=a(b.target).text();return q.shi.id=c,q.shi.text=d,q.xian.id=null,q.xian.text="",2==o.deep?(D(),!1):void f(c,k)}),k.on("click",function(b){a(this).find("a").removeClass("current"),a(b.target).addClass("current");var c=a(b.target).attr("data-value"),d=a(b.target).text();q.xian.id=c,q.xian.text=d,D()})},C=function(){m.trigger("click")},D=function(){C()}},jQuery.fn.isChildOf=function(a){return this.parents(a).length>0},jQuery.fn.isChildAndSelfOf=function(a){return this.closest(a).length>0}}(jQuery);